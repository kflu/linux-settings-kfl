#!/bin/sh

main() {
    local GOPHER_DIR="$HOME/gopher"; mkdir -p "$GOPHER_DIR"
    local GOPHER_LOG_DIR="$GOPHER_DIR/logs"; mkdir -p "$GOPHER_LOG_DIR"

    local title="$1"; shift
    [ -z "$title" ] && { echo 'Must specify title'; exit 1; }

    # gopher without map displays timestamp by default so no need time
    # local entry_fn="$(date +%Y-%m-%d-%H:%M:%S)_$(echo "$title" | sed -E 's/[^0-9a-zA-Z]/_/g').txt"
    local entry_fn="$GOPHER_LOG_DIR/$(echo "$title" | sed -E 's/[^0-9a-zA-Z]/_/g').txt"
    [ -e "$entry_fn" ] && { echo "$entry_fn already exists"; exit 1; }

    local tmp="$(mktemp)"
    echo                                  >> "$tmp"
    echo '# vim: set ts=8 noexpandtab :' >> "$tmp"
    local hash="$(cksum "$tmp")"
    trap "$(cat <<EOF
        [ -e "$tmp" ] && rm "$tmp"
        find "$GOPHER_LOG_DIR" -type f -print0 | xargs -0 chmod 644
        find "$GOPHER_LOG_DIR" -type d -print0 | xargs -0 chmod 755
EOF
    )" EXIT

    "$EDITOR" "$tmp"
    local hash2="$(cksum "$tmp")"

    [ "$hash" = "$hash2" ] && {
        echo "File content not change - abort"
        exit 1
    }

    echo "Creating entry: $entry_fn"
    mv "$tmp" "$entry_fn"
}

main "$@"
